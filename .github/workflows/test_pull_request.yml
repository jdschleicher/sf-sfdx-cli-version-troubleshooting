name: Test Pull Request

on:
  push:

env:
  GITHUB_JSON:                  ${{ toJSON(github) }}
  PACKAGE_NAME:                 ${{ vars.PACKAGE_NAME }} 
  DEVHUB_ALIAS:                 "devhub"
  SCRATCH_ORG_ALIAS:            "ci-scratch-org"

jobs:
  pull-request:
    runs-on: ${{ vars.GH_ACTIONS_OPERATING_SYSTEM }}

    outputs:
      workflow_start_time: ${{ steps.workflow_initialization.outputs.workflow_start_time }}
  
    steps:

      - name: CHECKOUT CURRENT REPOSITORY IN VIRTUAL MACHINE
        uses: actions/checkout@v3

      - name: SET WORKFLOW INITIALIZATION TIMESTAMP
        id: workflow_initialization
        shell: pwsh
        run: |
          Write-Host "CAPTURING TIMESTAMP ENVIRONMENT"
          $start_time = $(Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
          "workflow_start_time=$start_time" >> $env:GITHUB_OUTPUT

      - name: INSTALL SFDX CLI 
        run: sh 'ci-cd/install/install-sfdx.sh'

      - name: AUTHENTICATE DEVHUB AUTH URL
        env:
          DEVHUB_AUTH_URL: ${{ secrets.DEVHUB_AUTH_URL }}
        shell: pwsh
        run: . ./ci_system/sfdx/auth_url.ps1 -auth_url $env:DEVHUB_AUTH_URL -org_alias "$env:DEVHUB_ALIAS"
    
      - name: INSTALL TEXEI
        run: sh 'ci-cd/install/install-texei.sh'

      - name: CREATE SCRATCH ORG
        shell: pwsh
        run: . .\ci-cd\scratch_org\create_scratch_org.ps1 -devhub_alias $env:DEVHUB_ALIAS -scratch_org_alias $env:SCRATCH_ORG_ALIAS

      - name: INSTALL PACKAGE DEPENDENCIES TO SCRATCH ORG
        shell: pwsh
        run: . .\ci-cd\package\install-package-dependencies-texei-scratch.ps1 $env:SCRATCH_ORG_ALIAS $env:DEVHUB_ALIAS

      - name: PUSH SOURCE CODE BASE TO SCRATCH ORG
        shell: pwsh
        run: . .\ci-cd\scratch_org\push_src_to_scratch_org.ps1 -scratch_org_alias $env:SCRATCH_ORG_ALIAS

  validate-only-deploy-to-sit:
    runs-on: ${{ vars.GH_ACTIONS_OPERATING_SYSTEM }}

    env:
        SIT_ALIAS:                    "sit"
        SF_SIT_AUTH_URL:              ${{ secrets.SF_SIT_AUTH_URL }}
        
    steps:

      - name: CHECKOUT CURRENT REPOSITORY IN VIRTUAL MACHINE
        uses: actions/checkout@v3

      - name: INSTALL SFDX CLI 
        run: sh 'ci-cd/install/install-sfdx.sh'

      - name: AUTHENTICATE SIT ORG
        shell: pwsh
        run: . .\ci-cd\authenticate\authenticate-salesforce-authurl.ps1 -org_alias $env:SIT_ALIAS -auth_url $env:SF_SIT_AUTH_URL

      - name: VALIDATE ONLY DEPLOY TO SIT SANDBOX
        shell: pwsh
        run: |
          $default_package_directory = "force-app"
          . .\ci-cd\deploy\validate_only_deploy_by_default_package_path.ps1 -target_org_to_validate_against $env:SIT_ALIAS -path_to_validate $default_package_directory

